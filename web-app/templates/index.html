<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="../static/styles/styles.css" />
  <title>Predicción de accidente cardiovascular</title>

</head>

<body style="background-color: white">


  <div class="container">
    <header class="header">
      <h1 id="title" class="header__title">Predictor de riesgo de ACV.</h1>
      <p id="description" class="header__description">
        Ingresá tus datos para calcular si hay probabilidades de que sufras un ACV.
      </p>
      <img src="../static/brain_pic.png" alt="" aria-hidden="true" class="illustration" />
    </header>
    <main class="main">
      <form action="#" method="GET" id="survey-form" class="survey" novalidate>
        <div class="progressbar" tabindex="0" role="progressbar" aria-valuemin="1" aria-valuemax="5" aria-valuenow="1">
          <span class="progressbar__step active" aria-hidden="true"></span>
          <span class="progressbar__step" aria-hidden="true"></span>
          <span class="progressbar__step" aria-hidden="true"></span>
          <span class="progressbar__step" aria-hidden="true"></span>
          <span class="progressbar__step" aria-hidden="true"></span>
          <span class="progressbar__step" aria-hidden="true"></span>
          <span class="progressbar__step" aria-hidden="true"></span>
          <span class="progressbar__step" aria-hidden="true"></span>
          <span class="progressbar__step" aria-hidden="true"></span>
          <span class="progressbar__step" aria-hidden="true"></span>
        </div>

        <section class="survey__panel survey__panel--current" aria-hidden="false" data-index="1" data-panel="firstPanel"
          data-requirement="option">
          <h2 class="survey__panel__question">
            <span class="visuallyhidden">Question 1 of 9</span>¿Cuál es tu género?
          </h2>
          <div class="survey__panel__period">
            <div class="form-group">
              <input id="gen_fem" type="radio" name="question_1" value="female" />
              <label for="gen_fem">Femenino</label>
            </div>
            <div class="form-group">
              <input id="gen_masc" type="radio" name="question_1" value="male" />
              <label for="gen_masc">Masculino</label>
            </div>
          </div>
          <p class="error-message"></p>
        </section>

        <section class="survey__panel" aria-hidden="true" data-index="2" data-panel="secondPanel"
          data-requirement="option">
          <h2 class="survey__panel__question">
            <span class="visuallyhidden">Question 2 of 9 </span>¿Sufris de hipertension?
          </h2>
          <div class="survey__panel__satisfaction">
            <div class="form-group">
              <input id="hypertension_yes" type="radio" class="radiobox" name="question_2" value="yes" />
              <label for="hypertension_yes">Sí</label>
            </div>
            <div class="form-group">
              <input id="hypertension_no" type="radio" class="radiobox" name="question_2" value="no" />
              <label for="hypertension_no">No</label>
            </div>
          </div>
          <p class="error-message"></p>
        </section>

        <section class="survey__panel" aria-hidden="true" data-index="3" data-panel="thirdPanel"
          data-requirement="checkbox">
          <h2 class="survey__panel__question">
            <span class="visuallyhidden">Question 3 of 9 </span>¿Sufris alguna enfermedad del corazón?
          </h2>
          <div class="survey__panel__hearabout">
            <div class="form-group">
              <input type="radio" class="radiobox" id="coronary_yes" name="question_3" value="yes" />
              <label for="coronary_yes">Sí</label>
            </div>
            <div class="form-group">
              <input type="radio" class="radiobox" id="coronary_no" name="question_3" value="no" />
              <label for="coronary_no">No</label>
            </div>
          </div>
          <p class="error-message"></p>
        </section>

        <section class="survey__panel" aria-hidden="true" data-index="4" data-panel="fourthPanel"
          data-requirement="option">
          <h2 class="survey__panel__question">
            <span class="visuallyhidden">Question 4 of 9 </span>¿Alguna vez estuviste casado/a?
          </h2>
          <div class="survey__panel__recommendation">
            <div class="form-group">
              <input type="radio" class="radiobox" name="question_4" id="married_no" value="no" />
              <label for="married_no">No</label>
            </div>
            <div class="form-group">
              <input type="radio" class="radiobox" name="question_4" id="married_yes" value="yes" />
              <label for="married_yes">Yes</label>
            </div>
          </div>
          <p class="error-message"></p>
        </section>

        <section class="survey__panel" aria-hidden="true" data-index="5" data-panel="fifthPanel">
          <h2 class="survey__panel__question">
            <!--
                        acá creo que debería poner otra clase para que se centre mejor pero por ahora 
                        que funcion así
                    -->
            <span class="visuallyhidden">Question 5 of 9 </span>¿Cuál es tu tipo de trabajo?
          </h2>
          <div>
            <div class="survey__panel__personaldetails">
              <div class="survey__panel__period">
                <div class="form-group">
                  <input id="work_type_children" type="radio" name="question_5" value="children" />
                  <label for="work_type_children">Niño</label>
                </div>
                <div class="survey__panel__period">
                  <div class="form-group">
                    <input id="gen_fem" type="radio" name="question_5" value="govt_job" />
                    <label for="gen_fem">Sector público</label>
                  </div>
                </div>
                <div class="survey__panel__personaldetails">
                  <div class="survey__panel__period">
                    <div class="form-group">
                      <input id="gen_fem" type="radio" name="question_5" value="never_worked" />
                      <label for="gen_fem">Sector privado</label>
                    </div>
                    <div class="survey__panel__period">
                      <div class="form-group">
                        <input id="gen_fem" type="radio" name="question_5" value="private" />
                        <label for="gen_fem">Nunca trabajé</label>
                      </div>
                    </div>
                    <div class="survey__panel__personaldetails">
                      <div class="survey__panel__period">
                        <div class="form-group">
                          <input id="gen_fem" type="radio" name="question_5" value="self_employed" />
                          <label for="gen_fem">Autonómo</label>
                        </div>
                      </div>
                    </div>
                    <p class="error-message"></p>
        </section>

        <section class="survey__panel" aria-hidden="true" data-index="6" data-panel="sixthPanel">
          <h2 class="survey__panel__question">
            <span class="visuallyhidden">Question 6 of 9 </span>¿Cuál es tu tipo de residencia?
          </h2>
          <div class="survey__panel__period">
            <div class="form-group">
              <input id="res_rural" type="radio" name="question_6" value="rural" />
              <label for="res_rural">Rural</label>
            </div>
            <div class="form-group">
              <input id="res_urb" type="radio" name="question_6" value="urban" />
              <label for="res_urb">Urbano</label>
            </div>
          </div>
          <p class="error-message"></p>
        </section>

        <section class="survey__panel" aria-hidden="true" data-index="7" data-panel="seventhPanel">
          <h2 class="survey__panel__question">
            <span class="visuallyhidden">Question 7 of 9 </span>¿Cuál es tu nivel de glucosa?
          </h2>

          <div class="survey__panel__period">

            <input id="res_rural" type="number" name="question_7" />

          </div>
          <p class="error-message"></p>
        </section>

        <section class="survey__panel" aria-hidden="true" data-index="8" data-panel="eighthPanel">
          <h2 class="survey__panel__question">
            <span class="visuallyhidden">Question 8 of 9 </span>¿Cuál es tu edad?
          </h2>
          <div class="survey__panel__period">
            <div class="form-group">
              <input id="res_rural" type="number" name="question_8" />
            </div>

          </div>
          <p class="error-message"></p>
        </section>

        <section class="survey__panel" aria-hidden="true" data-index="9" data-panel="sixthPanel">
          <h2 class="survey__panel__question">
            <span class="visuallyhidden">Question 9 of 10 </span>¿Cuál es tu peso? ¿Y altura?
          </h2>
          <div>
            <div class="survey__panel__period">
              <div class="form-group">
                <input id="height" type="number" name="question_9_height" placeholder="Peso en kilos" />
              </div>
            </div>
            <div>
              <div class="survey__panel__period">
                <div class="form-group">
                  <input id="wheight" type="number" name="question_9_weight" placeholder="Altura en centímetros" />
                </div>

              </div>

            </div>
            <p class="error-message"></p>
        </section>

        <section class="survey__panel" aria-hidden="true" data-index="10" data-panel="tenthPanel">
          <h2 class="survey__panel__question">
            <!--
                        acá creo que debería poner otra clase para que se centre mejor pero por ahora 
                        que funcion así
                    -->
            <span class="visuallyhidden">Question 10 of 10 </span>¿Qué tan frecuentemente fumas?
          </h2>
          <div>
            <div class="survey__panel__personaldetails">
              <div class="survey__panel__period">
                <div class="form-group">
                  <input id="smokes_never" type="radio" name="question_10" value="never smoked" />
                  <label for="smokes_never">Nunca Fumé </label>
                </div>
                <div class="survey__panel__period">
                  <div class="form-group">
                    <input id="smokes_formerly" type="radio" name="question_10" value="formerly smoked" />
                    <label for="smokes_formerly">Fumé, pero ya no</label>
                  </div>
                </div>
                <div class="survey__panel__personaldetails">
                  <div class="survey__panel__period">
                    <div class="form-group">
                      <input id="smokes" type="radio" name="question_10" value="smokes" />
                      <label for="smokes">Actualmente fumo</label>
                    </div>
                  </div>
                </div>
                <p class="error-message"></p>
        </section>

        <section class="survey__panel" aria-hidden="true" data-index="11" data-panel="finalPanel" name="final">
          <h2 class="survey__panel__question">
            <span class="visuallyhidden">Respuesta </span>¿Pertenecés a un grupo de riesgo?
          </h2>
          <p>
            Sos riesgoso
          </p>
          <p class="error-message"></p>
        </section>




        <div class="form-buttons">
          <button class="button" type="button" name="prev" disabled="disabled" aria-label="Previous" aria-hidden="true">
            Prev
          </button>
          <button class="button" type="button" name="next" aria-label="Next" aria-hidden="false">Next</button>
          <button class="button" type="submit" id="submit" name="submit" disabled="disabled" aria-hidden="true">
            Submit
          </button>
        </div>
      </form>
      <div class="hidden" id="response" aria-hidden="true">
        <p> holaa :) </p>

      </div>
    </main>
  </div>

  <!-- <script src="https://cdn.freecodecamp.org/testable-projects-fcc/v1/bundle.js"></script> -->
  <script>




    function Survey(survey) {
      if (!survey) {
        throw new Error("No Survey Form found!");
      }

      // select the elements
      const progressbar = survey.querySelector(".progressbar");
      const surveyPanels = survey.querySelectorAll(".survey__panel");


      const question1Radios = survey.querySelectorAll("[name='question_1']");
      const question2Radios = survey.querySelectorAll("[name='question_2']");
      const question3CheckBoxes = survey.querySelectorAll("[name='question_3']");
      const question4Radios = survey.querySelectorAll("[name='question_4']");
      const question_5_Radio = survey.querySelectorAll("[name='question_5']");
      const question_6_Radio = survey.querySelectorAll("[name='question_6']");
      const question_7 = survey.querySelectorAll("[name='question_7']");
      const question_8 = survey.querySelectorAll("[name='question_8']");
      const question_9_height = survey.querySelectorAll("[name='question_9_height']");
      const question_9_weight = survey.querySelectorAll("[name='question_9_weight']");
      const question_10 = survey.querySelectorAll("[name='question_10']");
      const final_answer = survey.querySelectorAll("[name='final']");

      const allPanels = Array.from(survey.querySelectorAll(".survey__panel"));
      let progressbarStep = Array.from(
        progressbar.querySelectorAll(".progressbar__step ")
      );
      const mainElement = document.querySelector("main");
      const nextButton = survey.querySelector("[name='next']");
      const prevButton = survey.querySelector("[name='prev']");
      const submitButton = survey.querySelector("[name='submit']");
      let currentPanel = Array.from(surveyPanels).filter((panel) =>
        panel.classList.contains("survey__panel--current")
      )[0];
      const formData = {};
      const options = {
        question1Radios,
        question2Radios,
        question3CheckBoxes,
        question4Radios,
        question_5_Radio,
        question_6_Radio,
        question_7,
        question_8,
        question_9_height,
        question_9_weight,
        question_10
        //final_answer
      };
      let dontSubmit = false;


      document.getElementById("survey-form").addEventListener("submit", (e) => {
        e.preventDefault() 
        procesarYMostrar();
       
        //espero que me mande la respuesta y luego la muestro 
      })

      const procesarYMostrar = async () => {
        const backendResponse = await postToAPI();
        console.log(backendResponse.key);
        showPredictionResponse(backendResponse);

      }

      const postToAPI = async () => {
        // Se arma el body en formato JSON (igual que en postman)
       
       const formulario = document.getElementById('survey-form')
   
        const body = {
          'gender': formulario.question_1.value,
          'age': formulario.question_8.value,
          'hypertension':  formulario.question_2.value,
          'heart':  formulario.question_3.value,
          'married':  formulario.question_4.value,
          'work':  formulario.question_5.value,
          'residence': formulario.question_6.value,
          'glucose': formulario.question_7.value,
          'height': formulario.question_9_height.value,
          'wheight': formulario.question_9_weight.value,
          'smokes': formulario.question_10.value
        }
        console.log(body)
        // Se ejecuta la request
        const backResponse = await fetch('http://127.0.0.1:5000/predict', {
          headers: {
            "Content-Type": "application/json"
          },
          method: "POST",
          body: JSON.stringify(body)
        })
        // Retornamos la respuesta del backend
        return await backResponse.json()
      }

      function showPredictionResponse(predictionResponse) {

        const formulario = document.getElementById('survey-form')
        const respuesta = document.getElementById('response')
        formulario.classList.add('hidden');
        respuesta.classList.remove('hidden');
        

      }



      function storeInitialData() {
        allPanels.map((panel) => {
          let index = panel.dataset.index;
          let panelName = panel.dataset.panel;
          let question = panel
            .querySelector(".survey__panel__question")
            .textContent.trim();
          formData[index] = {
            panelName: panelName,
            question: question
          };
        });
      }

      function updateProgressbar() {
        let index = currentPanel.dataset.index;
        let currentQuestion = formData[`${parseFloat(index)}`].question;
        progressbar.setAttribute("aria-valuenow", index);
        progressbar.setAttribute("aria-valuetext", currentQuestion);
        progressbarStep[index - 1].classList.add("active");
      }

      function updateFormData(e) {
        const target = e.target

        const index = +currentPanel.dataset.index;
        const { name, type, value } = target;
        if (type === "checkbox") {
          if (formData[index].answer === undefined) {
            formData[index].answer = {
              [name]: [value]
            };
            return;
          }
          if (formData[index]["answer"][`${name}`].includes(value)) {
            const position = formData[index]["answer"][`${name}`].findIndex(
              (elem) => elem === value
            );
            formData[index]["answer"][`${name}`].splice(position, 1);
          } else {
            formData[index]["answer"][`${name}`].push(value);
          }
          return;
        }
        if (index === 4 || index === 5) {
          let copy;
          const original = formData[index].answer;
          if (original === undefined) {
            formData[index].answer = {
              [name]: value
            };
            copy = { ...formData[index].answer };
          } else {
            formData[index].answer = { ...original, [name]: value };
          }
          return;
        }

        formData[index].answer = {
          [name]: value
        };
      }

      function showError(input, text) {
        const formControl = input.parentElement;
        const errorElement = formControl.querySelector(".error-message");
        errorElement.innerText = text;
        errorElement.setAttribute("role", "alert");
        if (survey.classList.contains("form-error")) return;
        survey.classList.add("form-error");
      }

      function noErrors(input) {
        if (!input) {
          const errorElement = currentPanel.querySelector(".error-message");
          errorElement.textContent = "";
          errorElement.removeAttribute("role");
          survey.classList.remove("form-error");
          return;
        }
        const formControl = input.parentElement;
        const errorElement = formControl.querySelector(".error-message");
        errorElement.innerText = "";
        errorElement.removeAttribute("role");
      }

      function getName(input) {
        if (input.name === "age") return "Age";
        if (input.name === "country") return "Country";
        return `${input.id.charAt(0).toUpperCase()}${input.id.slice(1)}`;
      }

      function checkEmail(input) {
        if (input.value.trim() === "") {
          showError(input, `${getName(input)} is required`);
        } else {
          const pattern = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
          if (pattern.test(input.value.trim())) {
            noErrors(input);
          } else {
            showError(input, "Email is not valid");
          }
        }
      }

      function checkRequired(input) {
        if (input.value.trim() === "") {
          showError(input, `${getName(input)} is required`);
        } else {
          noErrors(input);
        }
      }

      function checkSelection(input) {
        if (input.selectedIndex === 0) {
          showError(input, `${getName(input)} is required`);
        } else {
          noErrors(input);
        }
      }

      function checkAge(age) {
        if (age.value === "") {
          showError(age, `${getName(age)} is required`);
          return;
        }
        if (+age.value > 0) {
          noErrors(age);
        }
      }

      function checkRequirements() {
        const requirement = currentPanel.dataset.requirement;
        const index = currentPanel.dataset.index;
        const errorElement = currentPanel.querySelector(".error-message");

        if (!formData[index].hasOwnProperty("answer") && +index === 10) {
        } else if (formData[index].hasOwnProperty("answer") && +index === 10) {
          const req = requirement.split(";");
          let data = Object.keys(formData[index].answer);
          let arr = [];
          let res;
          for (let i = 0; i < data.length; i++) {
            res = req.includes(data[i]) ? data[i] : "";
            arr.push(res);
          }
          if (
            arr.length === 9 &&
            arr.every((elem) => formData[index].answer.hasOwnProperty(elem))
          ) {
            survey.classList.remove("form-error");
            dontSubmit = true;
          }
        } else {
          errorElement.textContent = `Select an ${requirement} to continue.`;
          errorElement.setAttribute("role", "alert");
          survey.classList.add("form-error");
        }
      }

      function updateProgressbarBar() {
        const index = currentPanel.dataset.index;
        let currentQuestion = formData[`${parseFloat(index)}`].question;
        progressbar.setAttribute("aria-valuenow", index);
        progressbar.setAttribute("aria-valuetext", currentQuestion);
        progressbarStep[index].classList.remove("active");
      }

      function displayNextPanel() {
        currentPanel.classList.remove("survey__panel--current");
        currentPanel.setAttribute("aria-hidden", true);
        currentPanel = currentPanel.nextElementSibling;
        currentPanel.classList.add("survey__panel--current");
        currentPanel.setAttribute("aria-hidden", false);
        updateProgressbar();
        if (+currentPanel.dataset.index > 1) {
          prevButton.disabled = false;
          prevButton.setAttribute("aria-hidden", false);
        }
        if (+currentPanel.dataset.index === 10) {
          nextButton.disabled = true;
          nextButton.setAttribute("aria-hidden", true);
          submitButton.disabled = false;
          submitButton.setAttribute("aria-hidden", false);
        }

      }

      function displayPrevPanel() {
        currentPanel.classList.remove("survey__panel--current");
        currentPanel.setAttribute("aria-hidden", true);
        currentPanel = currentPanel.previousElementSibling;
        currentPanel.classList.add("survey__panel--current");
        currentPanel.setAttribute("aria-hidden", false);
        updateProgressbarBar();
        if (+currentPanel.dataset.index === 1) {
          prevButton.disabled = true;
          prevButton.setAttribute("aria-hidden", true);
        }
        if (+currentPanel.dataset.index < 10) {
          nextButton.disabled = false;
          nextButton.setAttribute("aria-hidden", false);
          submitButton.disabled = true;
          submitButton.setAttribute("aria-hidden", true);
        }

      }

      function handleprevButton() {
        displayPrevPanel();
      }

      function handleNextButton() {
        const index = currentPanel.dataset.index;
        if (!formData[index].hasOwnProperty("answer")) {
          checkRequirements();
        } else {
          noErrors();
          displayNextPanel();
        }
      }


      storeInitialData();

      // Add event listeners
      function addListenersTo({
        question1Radios,
        question2Radios,
        question3CheckBoxes,
        question4Radios,
        question_5_Radio,
        question_6_Radio,
        question_7,
        question_8,
        question_9_height,
        question_9_weight,
        ...inputs
      }) {
        question1Radios.forEach((elem) =>
          elem.addEventListener("change", updateFormData)
        );
        question2Radios.forEach((elem) =>
          elem.addEventListener("change", updateFormData)
        );
        question3CheckBoxes.forEach((elem) =>
          elem.addEventListener("change", updateFormData)
        );
        question4Radios.forEach((elem) =>
          elem.addEventListener("change", updateFormData)
        );
        question_5_Radio.forEach((elem) =>
          elem.addEventListener("change", updateFormData)
        );
        question_6_Radio.forEach((elem) =>
          elem.addEventListener("change", updateFormData)
        );
        question_7.forEach((elem) =>
          elem.addEventListener("change", updateFormData)
        );
        question_8.forEach((elem) =>
          elem.addEventListener("change", updateFormData)
        );
        question_9_weight.forEach((elem) =>
          elem.addEventListener("change", updateFormData)
        );
        question_9_height.forEach((elem) =>
          elem.addEventListener("change", updateFormData)
        );
        let {

        } = inputs;

      }
      nextButton.addEventListener("click", handleNextButton);
      prevButton.addEventListener("click", handleprevButton);
      addListenersTo(options);
    }

    const survey = Survey(document.querySelector(".survey"));



  </script>


</body>



</html>


<!--

    1. Aparezcan en la pantalla todas las variables a considerar
    2. Mandar datos del front al back 
        2.1 back recibe los datos 
        2.2 back manda datos a la api 
    3. responder el resultado a la consulta
    4. cambiar el diseño de la pantalla EN FUNCIÓN del resultado en 3 
    5. dejar linda la pagina :P


-->